<!DOCTYPE html>
<html>
<head>
    <title>feature_dashboard_by_tag</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",itemId:"appHeaderContainer",padding:"15 15 15 15"},{xtype:"container",itemId:"featureGridContainer",padding:"15 15 15 15"},{xtype:"container",itemId:"cfdContainer",padding:"15 15 15 15"}],gSkipTagPicker:!0,gTagName:void 0,gFeatureObjectIDArr:[],aCalc:void 0,launch:function(){if(console.log("App in Running!!!"),this.gSkipTagPicker===!1){var aContainer=this.down("#appHeaderContainer");aTagPicker=Ext.create("Rally.ui.picker.MultiObjectPicker",{modelType:"tag",fieldLabel:"Pick your Tag Yo",listeners:{select:function(theTagPicker,theSelectedValue){this.gTagName=theSelectedValue.get("Name"),console.log("this.gTagName: "+this.gTagName),this._selectTaggedFeatures()},scope:this}}),aContainer.add(aTagPicker)}else this.gTagName="Customer B",this._selectTaggedFeatures()},_selectTaggedFeatures:function(){console.log("B ==> _selectTaggedFeatures()"),console.log("this.gTagName: "+this.gTagName);var store=Ext.create("Rally.data.WsapiDataStore",{model:"PortfolioItem/Feature",fetch:["ObjectID","Name","ActualStartDate","Project","FormattedID","ActualEndDate","PlannedStartDate","PlannedEndDate","LeafStoryCount","LeafStoryPlanEstimateTotal","AcceptedLeafStoryCount","AcceptedLeafStoryPlanEstimateTotal","PercentDoneByStoryCount","PercentDoneByStoryPlanEstimate"],context:{project:"/project/11377984352",projectScopeUp:!1,projectScopeDown:!0},filters:[{property:"Tags.Name",operator:"contains",value:this.gTagName}],limit:1/0,autoLoad:!0,listeners:{load:function(store,records,success){console.log("Loading freaking data baby"),this._tableOfContents(records)},scope:this}});console.log("E ==> _selectTaggedFeatures()\n")},_tableOfContents:function(theTaggedFeatures){console.log("B ==> _tableOfContents()\n"),this._processTaggedFeatures(theTaggedFeatures),this._gridTaggedFeatures(theTaggedFeatures),this._driveCFD(),console.log("E ==> _tableOfContents()\n")},_processTaggedFeatures:function(theTaggedFeatures){console.log("B ==> _processTaggedFeatures()");var nbrFeatures;nbrFeatures=theTaggedFeatures.length,console.log("nbrFeatures: "+nbrFeatures+"\n");var that=this;Ext.each(theTaggedFeatures,function(aFeature){if(null!==aFeature){var aFeatureObjectID=aFeature.get("ObjectID"),aFeatureName=aFeature.get("Name"),aProjectName=aFeature.get("Project").Name;console.log("aFeatureObjectID: "+aFeatureObjectID),console.log("aFeatureName: "+aFeatureName),console.log("aProjectName: "+aProjectName),aFeature.set("ProjectName",aProjectName),console.log('aFeature.get("ProjectName"): '+aFeature.get("ProjectName")+"\n");var anObjectID=Object(aFeatureObjectID);console.log("anObjectID: "+anObjectID);var len=that.gFeatureObjectIDArr.length;console.log("len: "+len),that.gFeatureObjectIDArr.push(anObjectID),console.log(that.gFeatureObjectIDArr)}}),console.log("E ==> _processTaggedFeatures()\n")},_gridTaggedFeatures:function(theTaggedFeatures){console.log("B ==> _gridTaggedFeatures()");var featureStore=Ext.create("Rally.data.custom.Store",{data:theTaggedFeatures}),featureGrid=Ext.create("Rally.ui.grid.Grid",{title:"Tagged Features",store:featureStore,columnCfgs:[{text:"ObjectID",dataIndex:"ObjectID",flex:1},{text:"FormattedID",dataIndex:"FormattedID",flex:1},{text:"Name",dataIndex:"Name",flex:2},{text:"Project",dataIndex:"ProjectName",flex:1},{text:"Leaf Stories (Count)",dataIndex:"LeafStoryCount",flex:1},{text:"Leaf Stories (Size)",dataIndex:"LeafStoryPlanEstimateTotal",flex:3}]}),gridHolder=this.down("#featureGridContainer");gridHolder.removeAll(!0),gridHolder.add(featureGrid),console.log("E ==> _gridTaggedFeatures()\n")},_driveCFD:function(){console.log("B ==> _driveCFD()");var TIME_PERIOD_IN_MONTHS=2,TIME_PERIOD_IN_MILLIS=2592e6*TIME_PERIOD_IN_MONTHS;this.aCalc=Ext.define("ProjectCFDCalculator",{extend:"Rally.data.lookback.calculator.TimeSeriesCalculator",values:["Idea","Defined","In-Progress","Completed","Accepted","Released"],getDerivedFieldsOnInput:function(){var dfs=[],fieldName="ScheduleState",that=this;return _.each(that.values,function(value){var s="return snapshot['"+fieldName+"'] == '"+value+"' ? 1 : 0;",fn=Function("snapshot",s);dfs.push({as:value,f:fn})}),dfs},getMetrics:function(){var metrics=[],that=this;return _.each(that.values,function(value){metrics.push({field:value,as:value,f:"sum",display:"area"})}),console.log(metrics),metrics}});var today=new Date,timePeriod=new Date(today-TIME_PERIOD_IN_MILLIS);this.chartConfig.storeConfig.find._ProjectHierarchy=11377984352,this.chartConfig.storeConfig.find.Project={$exists:!0},this.chartConfig.storeConfig.find._ValidFrom={$gt:timePeriod.toISOString()},this.chartConfig.chartConfig.title={text:this.getContext().getProject().Name+" Cumulative Flow Diagram"};var cfdHolder=this.down("#cfdContainer");cfdHolder.removeAll(!0),cfdHolder.add(this.chartConfig),console.log("B ==> _driveCFD()")},chartConfig:{xtype:"rallychart",storeConfig:{find:{_TypeHierarchy:{$in:["HierarchicalRequirement","Defect"]},Children:null},fetch:["ScheduleState","PlanEstimate"],hydrate:["ScheduleState"]},calculatorType:"ProjectCFDCalculator",calculatorConfig:{},chartConfig:{chart:{zoomType:"xy"},title:{text:"Cumulative Flow Diagram"},xAxis:{tickmarkPlacement:"on",tickInterval:20,title:{text:"Days"}},yAxis:[{title:{text:"Count"}}],plotOptions:{series:{marker:{enabled:!0}},area:{stacking:"normal"}}}}});

            Rally.launchApp('CustomApp', {
                name:"feature_dashboard_by_tag",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
